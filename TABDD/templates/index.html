<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XPTOISEP</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <!-- Menu Lateral -->
    <div class="sidebar" id="sidebar">
        <div class="container">
            <h4>Menu</h4>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="#" id="productsMenu">Produtos</a>
                    <!-- Exibe as categorias e subcategorias aqui -->
                    <ul class="nav flex-column ms-3" id="productsCategories" style="display:none;">
                        {% for category in categories %}
                            <li class="nav-item">
                                <a class="nav-link" href="/?category_id={{ category[0] }}">{{ category[1] }}</a>
                                <!-- Exibir subcategorias dentro de cada categoria -->
                                <ul class="nav flex-column ms-3" id="subcategories-{{ category[0] }}" style="display:none;">
                                    {% for subcategory in subcategories %}
                                        {% if subcategory[3] == category[0] %}
                                            <li class="nav-item">
                                                <a class="nav-link" href="/?subcategory_id={{ subcategory[0] }}">{{ subcategory[1] }}</a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                            </li>
                        {% endfor %}
                    </ul>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="servicesMenu">Serviços</a>
                    <ul class="nav flex-column ms-3" id="servicesCategories" style="display:none;">
                        <li class="nav-item"><a class="nav-link" href="#">Assistência Técnica</a></li>
                        <li class="nav-item"><a class="nav-link" href="#">Instalação</a></li>
                        <li class="nav-item"><a class="nav-link" href="#">Consultoria</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>

    <!-- Ícone de Menu -->
    <button class="btn btn-outline-primary menu-toggle" id="menuToggle">&#9776;</button>

    <!-- Barra de navegação superior -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="/">XPTOISEP</a>
            <!-- Barra de pesquisa -->
            <form class="d-flex search-bar" action="/" method="GET">
                <input class="form-control me-2" type="search" placeholder="Pesquisar produtos" aria-label="Pesquisar" name="search_query">
                <button class="btn btn-outline-success" type="submit">Pesquisar</button>
            </form>

            <!-- Login/Cadastro ou Nome do Usuário -->
            <div class="ml-auto">
                {% if user_logged_in %}
                    <a href="#" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#profileModal">
                        {{ user_name }}
                    </a>
                    <a href="/logout" class="btn btn-outline-danger">Sair</a>
                    {% if user_role == 'delivery order manager' %}
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#orderLocationModal">
                            Localizar Orders
                        </button>
                    {% endif %}
                    {% if user_role == 'manager' %}
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#orderViewModal">
                            Ver Orders
                        </button>
                    {% endif %}
                {% else %}
                    <!-- Login/Cadastro modal trigger -->
                    <a href="#" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#loginRegisterModal">Login/Registar</a>
                {% endif %}
                    <!-- Botão de visualizar o carrinho -->
                <a href="#" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#cartModal">
                    Ver Carrinho
                </a>
            </div>
        </div>
    </nav>

    <!-- Modal para Localizar Ordens -->
    <div class="modal fade" id="orderLocationModal" tabindex="-1" aria-labelledby="orderLocationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderLocationModalLabel">Localizações das Ordens</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="locationForm-order-location">
                        <label for="datetime-picker-order-location">Selecione a Data e Hora:</label>
                        <input type="datetime-local" id="datetime-picker-order-location" name="selected_datetime" class="form-control mb-3" required>
                        <button type="submit" id="search-locations-btn-order-location" class="btn btn-primary w-100">Buscar Localizações</button>
                    </form>
                    <div id="orderLocationsTable-order-location" style="display:none;" class="mt-3">
                        <h3>Resultados encontrados:</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Código do Pedido</th>
                                    <th>Data do Pedido</th>
                                    <th>Localização</th>
                                    <th>Data e Hora</th>
                                </tr>
                            </thead>
                            <tbody id="orderLocationsBody-order-location"></tbody>
                        </table>
                    </div>
                    <div id="noOrdersMessage-order-location" class="text-danger mt-3" style="display:none;">Nenhuma ordem encontrada para a data e hora selecionadas.</div>
                </div>
            </div>
        </div>
    </div>



    <!-- Modal para o Manager Localizar Compras -->
    <div class="modal fade" id="orderViewModal" tabindex="-1" aria-labelledby="orderViewModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderViewModalLabel">Filtrar Orders</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Formulário para filtrar compras -->
                    <form id="filter-form">
                        <div class="mb-3">
                            <label for="start_date" class="form-label">Data de Compra Inicial:</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" required>
                        </div>
                        <div class="mb-3">
                            <label for="end_date" class="form-label">Data de Compra Final:</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" required>
                        </div>

                        <div class="mb-3">
                            <label for="prep_time_comparison" class="form-label">Tempo de Preparação:</label>
                            <select class="form-select" id="prep_time_comparison" name="prep_time_comparison">
                                <option value="less">Menos de 10 horas</option>
                                <option value="more">Mais de 10 horas</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="days_diff_comparison" class="form-label">Diferença de Dias (Compra x Entrega):</label>
                            <select class="form-select" id="days_diff_comparison" name="days_diff_comparison">
                                <option value="more">Mais de 10 dias</option>
                                <option value="less">Menos de 10 dias</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">Filtrar Compras</button>
                    </form>

                    <!-- Exibição das ordens encontradas -->
                    <div id="no-orders-message" class="mt-3 text-danger" style="display:none;">Nenhuma compra encontrada para os critérios selecionados.</div>
                    <ul id="orders-list" class="mt-3"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Perfil do Usuário -->
    <div class="modal" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="profileModalLabel">Informações do Usuário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Nome:</strong> {{ user_name }}</p>
                    <p><strong>Email:</strong> {{ user_email }}</p>
                    <p><strong>Data de Nascimento:</strong> {{ user_dob }}</p>
                    <p><strong>Role:</strong> {{ user_role }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Localizar Ordens -->
    <div class="modal fade" id="orderLocationModal" tabindex="-1" aria-labelledby="orderLocationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderLocationModalLabel">Localizações das Ordens</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="locationForm">
                        <label for="datetime-picker">Selecione a Data e Hora:</label>
                        <input type="datetime-local" id="datetime-picker" name="selected_datetime" class="form-control mb-3" required>
                        <button type="submit" id="search-locations-btn" class="btn btn-primary w-100">Buscar Localizações</button>
                    </form>
                    <div id="orderLocationsTable" style="display:none;" class="mt-3">
                        <h3>Resultados encontrados:</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Código do Pedido</th>
                                    <th>Data do Pedido</th>
                                    <th>Localização</th>
                                    <th>Data e Hora</th>
                                </tr>
                            </thead>
                            <tbody id="orderLocationsBody"></tbody>
                        </table>
                    </div>
                    <div id="noOrdersMessage" class="text-danger mt-3" style="display:none;">Nenhuma ordem encontrada para a data e hora selecionadas.</div>                    
                </div>
            </div>
        </div>
    </div>


    <!-- Modal de Login e Registro -->
    <div class="modal fade" id="loginRegisterModal" tabindex="-1" aria-labelledby="loginRegisterModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginRegisterModalLabel">Login ou Cadastro</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" id="login-tab" data-bs-toggle="tab" href="#login" role="tab" aria-controls="login" aria-selected="true">Login</a>
                        </li>
                        <li class="nav-item" role="presentation">
                            <a class="nav-link" id="register-tab" data-bs-toggle="tab" href="#register" role="tab" aria-controls="register" aria-selected="false">Registrar</a>
                        </li>
                    </ul>
                    <div class="tab-content" id="myTabContent">
                        <!-- Formulário de Login -->
                        <div class="tab-pane fade show active" id="login" role="tabpanel" aria-labelledby="login-tab">
                            <form action="/login" method="POST">
                                <div class="mb-3">
                                    <label for="email" class="form-label">E-mail</label>
                                    <input type="email" class="form-control" id="email" name="email" required>
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label">Senha</label>
                                    <input type="password" class="form-control" id="password" name="password" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Entrar</button>
                            </form>
                        </div>

                        <!-- Formulário de Registo -->
                        <div class="tab-pane fade" id="register" role="tabpanel" aria-labelledby="register-tab">
                            <form action="/register" method="POST">
                                <div class="mb-3">
                                    <label for="firstName" class="form-label">Primeiro Nome</label>
                                    <input type="text" class="form-control" id="firstName" name="firstName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="lastName" class="form-label">Sobrenome</label>
                                    <input type="text" class="form-control" id="lastName" name="lastName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="email" class="form-label">E-mail</label>
                                    <input type="email" class="form-control" id="email" name="email" required>
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label">Senha</label>
                                    <input type="password" class="form-control" id="password" name="password" required>
                                </div>
                                <div class="mb-3">
                                    <label for="phone" class="form-label">Telefone</label>
                                    <input type="text" class="form-control" id="phone" name="phone">
                                </div>
                                <div class="mb-3">
                                    <label for="address" class="form-label">Endereço</label>
                                    <input type="text" class="form-control" id="address" name="address">
                                </div>
                                <div class="mb-3">
                                    <label for="vatNumber" class="form-label">Número de Contribuinte (VAT)</label>
                                    <input type="text" class="form-control" id="vatNumber" name="vatNumber">
                                </div>
                                <div class="mb-3">
                                    <label for="dob" class="form-label">Data de Nascimento</label>
                                    <input type="date" class="form-control" id="dob" name="dob" required>
                                </div>
                                <div class="mb-3">
                                    <label for="role" class="form-label">Selecione o Papel</label>
                                    <select class="form-select" id="role" name="role" required>
                                        <option value="customer">customer</option>
                                        <option value="manager">manager</option>
                                        <option value="warehouse manager">warehouse manager</option>
                                        <option value="delivery order manager">delivery order manager</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Cadastrar</button>
                            </form>                                                        
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para exibir as localizações das ordens -->
    <div class="modal fade" id="quantityModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Escolha a Quantidade</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="quantityForm">
                        <input type="number" id="quantity" name="quantity" min="1" value="1" class="form-control" required>
                        <input type="hidden" id="product_id" name="product_id">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="submit" form="quantityForm" class="btn btn-primary">Adicionar ao Carrinho</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="quantityModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Escolha a Quantidade</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="quantityForm">
                        <input type="number" id="quantity" name="quantity" min="1" value="1" class="form-control" required>
                        <input type="hidden" id="product_id" name="product_id">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="submit" form="quantityForm" class="btn btn-primary">Adicionar ao Carrinho</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Exibição dos produtos -->
    <h1 class="product-title">Produtos</h1>
    <div class="row">
        {% for product in products %}
            <div class="col-md-3 mb-4">
                <div class="card">
                    <img src="{{ product['productImage'] | default('image_url_default') }}" class="card-img-top" alt="{{ product['productName'] }}">
                    <div class="card-body">
                        <h5 class="card-title">{{ product['productName'] }}</h5>
                        <p class="card-text">€{{ product['price'] }}</p>
                        <button class="btn btn-success" 
                                data-bs-toggle="modal" 
                                data-bs-target="#quantityModal" 
                                data-product-id="{{ product['productCode'] }}">
                            Adicionar ao Carrinho
                        </button>
                        <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#productDetailsModal" data-product-id="{{ product['productCode'] }}">
                            Detalhes
                        </button>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>  

    <!-- Paginador para navegar entre as páginas -->
    <div class="d-flex justify-content-center mt-4">
        <ul class="pagination">
            {% if page_number > 1 %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_number - 1 }}" aria-label="Anterior">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">&laquo;</span>
                </li>
            {% endif %}
            
            <!-- Exibe o número da página atual e as opções de navegação -->
            <li class="page-item active">
                <span class="page-link">{{ page_number }}</span>
            </li>

            <li class="page-item">
                <a class="page-link" href="?page={{ page_number + 1 }}" aria-label="Próxima">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        </ul>
    </div>
    
    <!-- Modal do Carrinho -->
    <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cartModalLabel">Carrinho de Compras</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="cartItems">
                        <p>Carregando seu carrinho...</p>
                    </div>
                    <div id="cartTotal">
                        <p>Total: €0.00</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary">Finalizar Compra</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes do Produto -->
    <div class="modal fade" id="productDetailsModal" tabindex="-1" aria-labelledby="productDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productDetailsModalLabel">Detalhes do Produto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Informações do Produto -->
                    <p><strong>Nome:</strong> <span id="product-name"></span></p>
                    <p><strong>Preço:</strong> €<span id="product-price"></span></p>
                    <p><strong>Fornecedor:</strong> <span id="product-supplier"></span></p>
                    <p><strong>Quantidade em Stock:</strong> <span id="product-stock"></span></p>

                    <h6>Atributos Físicos</h6>
                    <ul id="product-physical-attributes"></ul>

                    <h6>Atributos Técnicos</h6>
                    <ul id="product-technical-attributes"></ul>

                    <h6>Avaliações</h6>
                    <ul id="product-reviews">
                        <li>Sem avaliações disponíveis.</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cartModalLabel">Carrinho de Compras</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% if cart_items %}
                        <div class="cart-items">
                            {% for item in cart_items %}
                                <div class="row align-items-center mb-3">
                                    <div class="col-md-4">
                                        <strong>{{ item.productName }}</strong>
                                    </div>
                                    <div class="col-md-2">
                                        €{{ item.price }}
                                    </div>
                                    <div class="col-md-2">
                                        Quantidade: {{ item.quantity }}
                                    </div>
                                    <div class="col-md-2">
                                        Total: €{{ item.total_price }}
                                    </div>
                                    <div class="col-md-2 text-end">
                                        <!-- Botão para remover 1 unidade -->
                                        <form action="/remove_from_cart" method="POST" style="display:inline;">
                                            <input type="hidden" name="product_code" value="{{ item.productCode }}">
                                            <input type="hidden" name="quantity" value="1">
                                            <button type="submit" class="btn btn-danger btn-sm">Remover 1</button>
                                        </form>
                                        <!-- Botão para remover tudo -->
                                        <form action="/remove_from_cart" method="POST" style="display:inline;">
                                            <input type="hidden" name="product_code" value="{{ item.productCode }}">
                                            <input type="hidden" name="quantity" value="{{ item.quantity }}">
                                            <button type="submit" class="btn btn-danger btn-sm">Remover Tudo</button>
                                        </form>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <hr>
                        <div class="text-end">
                            <strong>Total do Carrinho: €{{ total_price }}</strong>
                        </div>
                    {% else %}
                        <p>Seu carrinho está vazio.</p>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary">Finalizar Compra</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar ao Carrinho -->
    <div class="modal fade" id="quantityModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Escolha a Quantidade</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="quantityForm">
                        <input type="number" id="quantity" name="quantity" min="1" value="1" class="form-control" required>
                        <input type="hidden" id="product_id" name="product_id">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="submit" form="quantityForm" class="btn btn-primary">Adicionar ao Carrinho</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap JS e Popper -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>

    <script>
        // Passar os dados do produto para o modal
        document.getElementById('productDetailsModal').addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget; // O botão que disparou o modal
            const productId = button.getAttribute('data-product-id'); // ID do produto

            // Requisição para obter os dados do produto
            fetch(`/product_details/${productId}`)
                .then(response => {
                    if (!response.ok) {
                        console.error('Falha na requisição:', response.statusText);
                        throw new Error('Erro na requisição');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Dados do produto:', data);  // Verifique se está imprimindo os dados

                    // Preencher os dados do produto no modal
                    document.getElementById('product-name').textContent = data.productName;
                    document.getElementById('product-price').textContent = data.price;
                    document.getElementById('product-supplier').textContent = data.supplierCode;
                    document.getElementById('product-stock').textContent = data.stock;

                    // Preencher os atributos físicos
                    const physicalAttributesList = document.getElementById('product-physical-attributes');
                    physicalAttributesList.innerHTML = `
                        <li><strong>Cor:</strong> ${data.physicalAttributes[0]}</li>
                        <li><strong>Peso:</strong> ${data.physicalAttributes[1]}</li>
                        <li><strong>Altura:</strong> ${data.physicalAttributes[2]}</li>
                        <li><strong>Largura:</strong> ${data.physicalAttributes[3]}</li>
                        <li><strong>Profundidade:</strong> ${data.physicalAttributes[4]}</li>
                    `;

                    // Preencher os atributos técnicos
                    const technicalAttributesList = document.getElementById('product-technical-attributes');
                    technicalAttributesList.innerHTML = `
                        <li><strong>Processador:</strong> ${data.technicalAttributes[0]}</li>
                        <li><strong>RAM:</strong> ${data.technicalAttributes[1]}</li>
                        <li><strong>Armazenamento:</strong> ${data.technicalAttributes[2]}</li>
                        <li><strong>Vida da Bateria:</strong> ${data.technicalAttributes[3]}</li>
                        <li><strong>Garantia:</strong> ${data.technicalAttributes[4]}</li>
                    `;

                    // Preencher as avaliações
                    const reviewsList = document.getElementById('product-reviews');
                    reviewsList.innerHTML = ''; // Limpa as avaliações existentes

                    if (data.ratings && data.ratings.length > 0) {
                        data.ratings.forEach(review => {
                            const reviewItem = document.createElement('li');
                            reviewItem.textContent = `Nota: ${review.rating} - Comentário: ${review.comment} - Cliente: ${review.user.name}`;
                            reviewsList.appendChild(reviewItem);
                        });
                    } else {
                        reviewsList.innerHTML = '<li>Não há avaliações para este produto.</li>';
                    }
                })
                .catch(err => {
                    console.error('Erro ao carregar os detalhes do produto:', err);
                });
        });

        document.getElementById('locationForm-order-location').addEventListener('submit', function (event) {
            event.preventDefault();

            const selectedDatetime = document.getElementById('datetime-picker-order-location').value;
            if (!selectedDatetime) {
                alert("Por favor, selecione uma data e hora.");
                return;
            }

            fetch(`/order_locations?selected_datetime=${encodeURIComponent(selectedDatetime)}`)
                .then(response => response.json())
                .then(data => {
                    const resultsContainer = document.getElementById('orderLocationsTable-order-location');
                    const noResultsMsg = document.getElementById('noOrdersMessage-order-location');
                    const locationsBody = document.getElementById('orderLocationsBody-order-location');
                    locationsBody.innerHTML = '';
                    resultsContainer.style.display = 'none';
                    noResultsMsg.style.display = 'none';

                    if (data.orders && data.orders.length > 0) {
                        data.orders.forEach(order => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${order.orderCode}</td>
                                <td>${order.orderDate}</td>
                                <td>${order.location}</td>
                                <td>${order.timestamp}</td>
                            `;
                            locationsBody.appendChild(row);
                        });
                        resultsContainer.style.display = 'block';
                    } else {
                        noResultsMsg.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error("Erro ao buscar as localizações das ordens:", error);
                    alert("Erro ao buscar as localizações das ordens.");
                });
        });

        document.getElementById('filter-form').addEventListener('submit', function(event) {
            event.preventDefault();

            // Captura os valores do formulário
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            const prepTimeComparison = document.getElementById('prep_time_comparison').value;
            const daysDiffComparison = document.getElementById('days_diff_comparison').value;

            // Faz a requisição AJAX
            fetch(`/manager_purchases?start_date=${startDate}&end_date=${endDate}&prep_time_comparison=${prepTimeComparison}&days_diff_comparison=${daysDiffComparison}`)
                .then(response => response.json())
                .then(data => {
                    const ordersList = document.getElementById('orders-list');
                    const noOrdersMessage = document.getElementById('no-orders-message');

                    // Limpa o conteúdo anterior
                    ordersList.innerHTML = '';
                    noOrdersMessage.style.display = 'none';

                    // Processa os resultados
                    if (data.purchases && data.purchases.length > 0) {
                        data.purchases.forEach(order => {
                            const listItem = document.createElement('li');
                            listItem.textContent = `Código: ${order.orderCode}, Data: ${order.orderDate}, Total: €${order.totalAmount}, Status: ${order.status}`;
                            ordersList.appendChild(listItem);
                        });
                    } else {
                        noOrdersMessage.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar as compras:', error);
                    alert('Erro ao buscar as compras.');
                });
        });


        document.getElementById('order-manager-form').addEventListener('submit', function(event) {
            event.preventDefault(); // Previne o envio padrão do formulário

            // Obtenha os dados do formulário
            const start_date = document.getElementById('start_date').value;
            const end_date = document.getElementById('end_date').value;
            const prep_time_comparison = document.getElementById('prep_time_comparison').value;
            const days_diff_comparison = document.getElementById('days_diff_comparison').value;

            // Verifique os valores do formulário antes de fazer a requisição
            console.log('Start Date:', start_date);
            console.log('End Date:', end_date);
            console.log('Preparation Time Comparison:', prep_time_comparison);
            console.log('Days Difference Comparison:', days_diff_comparison);

            // Requisição ao servidor para obter as ordens
            fetch(`/manager_purchases?start_date=${start_date}&end_date=${end_date}&prep_time_comparison=${prep_time_comparison}&days_diff_comparison=${days_diff_comparison}`)
                .then(response => response.json())
                .then(data => {
                    // Verifique a resposta do servidor
                    console.log('Resposta do servidor:', data);
                    // Lógica para processar os resultados e exibir
                })
                .catch(error => {
                    console.error('Erro ao buscar ordens:', error);
                    alert('Erro ao buscar ordens.');
                });
        });


        document.getElementById('search-locations-btn').addEventListener('click', function (event) {
            event.preventDefault();
            const selectedDatetime = document.getElementById('datetime-picker').value;
            if (!selectedDatetime) {
                alert("Por favor, selecione uma data e hora.");
                return;
            }
            fetch(`/order_locations?selected_datetime=${encodeURIComponent(selectedDatetime)}`)
                .then(response => response.json())
                .then(data => {
                    const resultsContainer = document.getElementById('orderLocationsTable');
                    const noResultsMsg = document.getElementById('noOrdersMessage');
                    const locationsBody = document.getElementById('orderLocationsBody');
                    locationsBody.innerHTML = '';
                    resultsContainer.style.display = 'none';
                    noResultsMsg.style.display = 'none';
                    if (data.orders && data.orders.length > 0) {
                        data.orders.forEach(order => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${order.orderCode}</td>
                                <td>${order.orderDate}</td>
                                <td>${order.location}</td>
                                <td>${order.timestamp}</td>
                            `;
                            locationsBody.appendChild(row);
                        });
                        resultsContainer.style.display = 'block';
                    } else {
                        noResultsMsg.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error("Erro ao buscar as localizações das ordens:", error);
                    alert("Erro ao buscar as localizações das ordens.");
                });
        });

        document.getElementById('locationForm').addEventListener('submit', function (event) {
            event.preventDefault(); // Impede o envio padrão do formulário

            const selectedDatetime = document.getElementById('datetime-picker').value;

            if (!selectedDatetime) {
                alert("Por favor, selecione uma data e hora.");
                return;
            }

            // Fazendo a requisição AJAX para o backend
            fetch(`/order_locations?selected_datetime=${encodeURIComponent(selectedDatetime)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro ao buscar localizações.');
                    }
                    return response.json();
                })
                .then(data => {
                    const resultsContainer = document.getElementById('orderLocationsTable');
                    const noResultsMsg = document.getElementById('noOrdersMessage');
                    const locationsBody = document.getElementById('orderLocationsBody');

                    // Limpa os resultados antigos
                    locationsBody.innerHTML = '';
                    resultsContainer.style.display = 'none';
                    noResultsMsg.style.display = 'none';

                    if (data.orders && data.orders.length > 0) {
                        data.orders.forEach(order => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${order.orderCode}</td>
                                <td>${order.orderDate}</td>
                                <td>${order.location}</td>
                                <td>${order.timestamp}</td>
                            `;
                            locationsBody.appendChild(row);
                        });
                        resultsContainer.style.display = 'block';
                    } else {
                        noResultsMsg.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar localizações:', error);
                    alert('Erro ao buscar localizações.');
                });
        });

        document.addEventListener('DOMContentLoaded', function () {
            const locationForm = document.getElementById('locationForm');
            const locationsTable = document.getElementById('orderLocationsTable');
            const locationsBody = document.getElementById('orderLocationsBody');
            const noOrdersMessage = document.getElementById('noOrdersMessage');

            if (locationForm) {
                locationForm.addEventListener('submit', function (event) {
                    event.preventDefault();

                    const selectedDatetime = document.getElementById('datetime-picker').value;

                    if (!selectedDatetime) {
                        alert("Por favor, selecione uma data e hora.");
                        return;
                    }

                    // Enviar para o backend
                    fetch(`/order_locations?selected_datetime=${encodeURIComponent(selectedDatetime)}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Erro ao buscar localizações');
                            }
                            return response.json();
                        })
                        .then(data => {
                            // Limpar a tabela anterior
                            locationsBody.innerHTML = '';
                            locationsTable.style.display = 'none';
                            noOrdersMessage.style.display = 'none';

                            if (data.orders && data.orders.length > 0) {
                                data.orders.forEach(order => {
                                    const row = document.createElement('tr');
                                    row.innerHTML = `
                                        <td>${order.orderCode}</td>
                                        <td>${order.orderDate}</td>
                                        <td>${order.location}</td>
                                        <td>${order.timestamp}</td>
                                    `;
                                    locationsBody.appendChild(row);
                                });
                                locationsTable.style.display = 'block';
                            } else {
                                noOrdersMessage.style.display = 'block';
                            }
                        })
                        .catch(error => {
                            console.error('Erro ao buscar as localizações das ordens:', error);
                            alert('Erro ao buscar as localizações das ordens.');
                        });
                });
            }

            // Gerenciar a seleção de produto no modal de quantidade
            const quantityForm = document.getElementById('quantityForm');
            const productIdField = document.getElementById('product_id');

            document.querySelectorAll('[data-bs-target="#quantityModal"]').forEach(button => {
                button.addEventListener('click', function () {
                    const productId = button.getAttribute('data-product-id');
                    if (productIdField) {
                        productIdField.value = productId;
                    }
                });
            });

            if (quantityForm) {
                quantityForm.addEventListener('submit', function (event) {
                    event.preventDefault();

                    const productId = productIdField ? productIdField.value : null;
                    const quantity = document.getElementById('quantity').value;

                    if (!productId || quantity < 1) {
                        alert('Por favor, selecione uma quantidade válida.');
                        return;
                    }

                    fetch('/add_to_cart', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ product_id: productId, quantity: quantity })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('Produto adicionado ao carrinho!');
                                const modal = bootstrap.Modal.getInstance(document.getElementById('quantityModal'));
                                modal.hide();
                                location.reload();
                            } else {
                                alert('Erro ao adicionar ao carrinho: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Erro ao adicionar ao carrinho:', error);
                            alert('Erro ao adicionar ao carrinho.');
                        });
                });
            }
            const addToCartBtn = document.getElementById('addToCartBtn');
                if (addToCartBtn) {
                    addToCartBtn.addEventListener('click', function () {
                        const productId = document.getElementById('product_id').value;
                        const quantity = document.getElementById('quantity').value;

                        if (!productId || quantity < 1) {
                            alert('Por favor, selecione uma quantidade válida.');
                            return;
                        }

                        fetch('/add_to_cart', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ product_id: productId, quantity: quantity })
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    alert('Produto adicionado ao carrinho!');
                                    const modal = bootstrap.Modal.getInstance(document.getElementById('quantityModal'));
                                    modal.hide();
                                    location.reload();
                                } else {
                                    alert('Erro ao adicionar ao carrinho: ' + data.message);
                                }
                            })
                            .catch(error => {
                                console.error('Erro ao adicionar ao carrinho:', error);
                                alert('Erro ao adicionar ao carrinho.');
                            });
                    });
                } else {
                    console.error("Botão 'addToCartBtn' não encontrado no DOM.");
                }
            // Exibir itens do carrinho no modal
            const cartModal = document.getElementById('cartModal');
            if (cartModal) {
                cartModal.addEventListener('show.bs.modal', function () {
                    console.log("Modal de carrinho aberto. Buscando itens no backend...");
        
                    fetch('/cart_data')
                        .then(response => {
                            console.log("Resposta recebida para dados do carrinho:", response);
                            return response.json();
                        })
                        .then(data => {
                            console.log("Dados do carrinho recebidos:", data);
        
                            const cartItemsContainer = document.getElementById('cartItems');
                            const cartTotal = document.getElementById('cartTotal');
        
                            cartItemsContainer.innerHTML = ""; // Limpar conteúdo anterior
        
                            if (data.items.length === 0) {
                                cartItemsContainer.innerHTML = "<p>Seu carrinho está vazio.</p>";
                                console.log("Carrinho vazio.");
                            } else {
                                data.items.forEach(item => {
                                    const itemHTML = `
                                        <div class="row">
                                            <div class="col-md-8">${item.productName}</div>
                                            <div class="col-md-2">€${item.price}</div>
                                            <div class="col-md-2">${item.quantity}</div>
                                        </div>
                                    `;
                                    cartItemsContainer.innerHTML += itemHTML;
                                });
                                console.log("Itens exibidos no carrinho.");
                            }
        
                            // Atualizar total do carrinho
                            cartTotal.innerHTML = `<p>Total: €${data.total_amount}</p>`;
                            console.log("Total do carrinho atualizado:", data.total_amount);
                        })
                        .catch(error => {
                            console.error("Erro ao carregar dados do carrinho:", error);
                            const cartItemsContainer = document.getElementById('cartItems');
                            cartItemsContainer.innerHTML = "<p>Erro ao carregar o carrinho.</p>";
                        });
                });
            } else {
                console.error("Modal de carrinho (cartModal) não encontrado.");
            }
        });
        
        const addToCartButtons = document.querySelectorAll('.btn-success');
        addToCartButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Pega o ID do produto
                const productId = this.getAttribute('data-product-id');
                
                // Define o ID do produto no campo oculto do formulário no modal
                document.getElementById('product_id').value = productId;
            });
        });

        document.getElementById('quantityModal').addEventListener('show.bs.modal', function () {
            const addToCartBtn = document.getElementById('addToCartBtn');
            if (addToCartBtn) {
                addToCartBtn.addEventListener('click', function () {
                    const productId = document.getElementById('product_id').value;
                    const quantity = document.getElementById('quantity').value;

                    if (!productId || quantity < 1) {
                        alert('Por favor, selecione uma quantidade válida.');
                        return;
                    }

                    fetch('/add_to_cart', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ product_id: productId, quantity: quantity })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('Produto adicionado ao carrinho!');
                                const modal = bootstrap.Modal.getInstance(document.getElementById('quantityModal'));
                                modal.hide();
                                location.reload();
                            } else {
                                alert('Erro ao adicionar ao carrinho: ' + data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Erro ao adicionar ao carrinho:', error);
                            alert('Erro ao adicionar ao carrinho.');
                        });
                });
            }
        });


        document.getElementById('cartModal').addEventListener('show.bs.modal', function () {
            // Fazer a requisição para obter os dados do carrinho
            fetch('/cart_data')  // Modifique esta URL conforme a sua rota
                .then(response => response.json())
                .then(data => {
                    // Preencher os itens do carrinho no modal
                    let cartItems = data.items;
                    let cartTotal = data.total_amount;

                    let cartItemsContainer = document.getElementById('cartItems');
                    cartItemsContainer.innerHTML = "";  // Limpa os itens anteriores

                    if (cartItems.length === 0) {
                        cartItemsContainer.innerHTML = "<p>Seu carrinho está vazio.</p>";
                    } else {
                        cartItems.forEach(item => {
                            let itemHTML = `
                                <div class="row">
                                    <div class="col-md-8">${item.productName}</div>
                                    <div class="col-md-2">€${item.price}</div>
                                    <div class="col-md-2">${item.quantity}</div>
                                </div>
                            `;
                            cartItemsContainer.innerHTML += itemHTML;
                        });
                    }

                    // Atualizar o total do carrinho
                    let totalHTML = `<p>Total: €${cartTotal}</p>`;
                    document.getElementById('cartTotal').innerHTML = totalHTML;
                })
                .catch(error => {
                    console.error('Erro ao carregar carrinho:', error);
                });
        });

        document.getElementById('gdpr-form').addEventListener('submit', function (e) {
            e.preventDefault();

            const consents = [
                { type: 'email_marketing', text: 'Consent to receive marketing emails.', status: 'revoked' },
                { type: 'push_notifications', text: 'Consent to receive push notifications.', status: 'granted' }
            ];

            fetch('/gdpr_popup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ consents })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Consentimentos salvos com sucesso.');
                        window.location.href = '/';
                    } else {
                        alert('Erro ao salvar os consentimentos.');
                    }
                })
                .catch(error => console.error('Erro ao enviar consentimentos:', error));
        });
    </script>            
</body>
</html>
